generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Lead {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  field     String
  website   String?
  noWebsite Boolean  @default(false)
  problem   String
  source    String   @default("funnel")

  emailsSent   Int      @default(0)
  lastEmailAt  DateTime?
  unsubscribed Boolean  @default(false)

  // Lead pipeline status
  status       String   @default("new") // new, contacted, replied, interested, booked, not_interested, unsubscribed
  tags         String?  // JSON array of tag strings

  // Email verification
  emailVerified Boolean  @default(false)
  verifyResult  String?  // valid, invalid, risky, catch_all, disposable, unknown
  verifiedAt    DateTime?

  // Bounce tracking
  bounceCount  Int      @default(0)
  lastBounceAt DateTime?
  bounceType   String?  // hard, soft

  // GDPR Compliance Fields
  consentGiven     Boolean   @default(false)
  consentTimestamp  DateTime?
  consentIp        String?
  unsubscribeToken String    @unique @default(cuid())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SendingAccount {
  id          String   @id @default(cuid())
  label       String
  email       String   @unique
  smtpHost    String
  smtpPort    Int      @default(587)
  smtpUser    String
  smtpPass    String   // AES-256-GCM encrypted at rest
  dailyLimit  Int      @default(20)
  sentToday   Int      @default(0)
  lastResetAt DateTime @default(now())
  warmupPhase Int      @default(1)
  warmupStart DateTime @default(now())
  active      Boolean  @default(true)

  // IMAP settings for reply tracking
  imapHost    String?
  imapPort    Int      @default(993)
  imapUser    String?
  imapPass    String?  // AES-256-GCM encrypted at rest

  // Send window (hours in UTC, e.g. 9-17 = 9am to 5pm)
  sendWindowStart Int  @default(8)   // UTC hour to start sending
  sendWindowEnd   Int  @default(18)  // UTC hour to stop sending
  sendWeekdays    String @default("1,2,3,4,5") // 0=Sun, 1=Mon, etc.

  // Warmup config
  warmupEnabled Boolean @default(false)
  warmupDaily   Int     @default(5)  // warmup emails per day

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  dailyLogs SendingLog[]
  warmupLogs WarmupLog[]
}

model SendingLog {
  id        String   @id @default(cuid())
  accountId String
  account   SendingAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  date      String
  sent      Int      @default(0)
  bounced   Int      @default(0)
  createdAt DateTime @default(now())

  @@unique([accountId, date])
}

model EmailCampaign {
  id          String    @id @default(cuid())
  subject     String
  body        String
  sentTo      Int       @default(0)
  totalLeads  Int       @default(0)
  sentAt      DateTime?
  scheduledAt DateTime?
  leadIds     String?
  status      String    @default("draft")

  // Bounce tracking
  bounceCount     Int    @default(0)
  bounceThreshold Int    @default(5) // Auto-pause at this bounce % rate

  // A/B testing variants (JSON array of {subject, body, weight})
  variants    String?

  createdAt   DateTime  @default(now())
}

model Sequence {
  id          String         @id @default(cuid())
  name        String
  active      Boolean        @default(true)
  autoEnroll  Boolean        @default(false)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  steps       SequenceStep[]
  enrollments SequenceEnrollment[]
}

model SequenceStep {
  id         String   @id @default(cuid())
  sequenceId String
  sequence   Sequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  order      Int
  delayDays  Int
  subject    String
  body       String
  createdAt  DateTime @default(now())

  @@unique([sequenceId, order])
}

model SequenceEnrollment {
  id          String    @id @default(cuid())
  sequenceId  String
  sequence    Sequence  @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  leadId      String
  currentStep Int       @default(0)
  nextSendAt  DateTime?
  status      String    @default("active")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([sequenceId, leadId])
}

model EmailTemplate {
  id        String   @id @default(cuid())
  name      String
  subject   String
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EmailEvent {
  id         String   @id @default(cuid())
  leadId     String
  campaignId String?
  accountId  String?
  type       String   // sent, bounced, opened, clicked, replied, unsubscribed
  details    String?  // bounce reason, link clicked, etc.
  createdAt  DateTime @default(now())

  @@index([leadId])
  @@index([campaignId])
  @@index([type])
}

model LeadList {
  id          String           @id @default(cuid())
  name        String
  description String?
  color       String           @default("#f97316") // UI badge color
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  members     LeadListMember[]
}

model LeadListMember {
  id        String   @id @default(cuid())
  listId    String
  list      LeadList @relation(fields: [listId], references: [id], onDelete: Cascade)
  leadId    String
  addedAt   DateTime @default(now())

  @@unique([listId, leadId])
  @@index([leadId])
}

model Domain {
  id          String   @id @default(cuid())
  name        String   @unique  // e.g. "outreach.example.com"
  spfRecord   String?
  dkimSelector String  @default("blok")
  dkimPublicKey String?
  dkimPrivateKey String? // AES-256-GCM encrypted
  dmarcRecord  String?
  verified    Boolean  @default(false)
  lastCheckAt DateTime?
  lastCheckResult String? // JSON: {spf, dkim, dmarc, mx} check results
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model InboxMessage {
  id          String   @id @default(cuid())
  accountId   String
  leadId      String?
  fromEmail   String
  toEmail     String
  subject     String
  bodyPreview String   // first 500 chars, no sensitive data stored
  messageId   String   @unique // IMAP message ID for dedup
  isAutoReply Boolean  @default(false)
  isOOO       Boolean  @default(false)
  read        Boolean  @default(false)
  receivedAt  DateTime
  createdAt   DateTime @default(now())

  @@index([accountId])
  @@index([leadId])
  @@index([receivedAt])
}

model WarmupLog {
  id        String   @id @default(cuid())
  accountId String
  account   SendingAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  date      String
  sent      Int      @default(0)
  received  Int      @default(0) // warmup replies received
  inbox     Int      @default(0) // landed in inbox (not spam)
  spam      Int      @default(0) // landed in spam
  createdAt DateTime @default(now())

  @@unique([accountId, date])
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String   // login, password_attempt, lead_export, account_create, etc.
  details   String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([action])
  @@index([createdAt])
}
