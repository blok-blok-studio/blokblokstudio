generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Lead {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  field     String
  website   String?
  noWebsite Boolean  @default(false)
  problem   String
  source    String   @default("funnel")

  emailsSent   Int      @default(0)
  lastEmailAt  DateTime?
  unsubscribed Boolean  @default(false)

  // Lead pipeline status
  status       String   @default("new") // new, contacted, replied, interested, booked, not_interested, unsubscribed
  tags         String?  // JSON array of tag strings

  // Email verification
  emailVerified Boolean  @default(false)
  verifyResult  String?  // valid, invalid, risky, catch_all, disposable, unknown
  verifiedAt    DateTime?

  // Bounce tracking
  bounceCount  Int      @default(0)
  lastBounceAt DateTime?
  bounceType   String?  // hard, soft

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SendingAccount {
  id          String   @id @default(cuid())
  label       String
  email       String   @unique
  smtpHost    String
  smtpPort    Int      @default(587)
  smtpUser    String
  smtpPass    String
  dailyLimit  Int      @default(20)
  sentToday   Int      @default(0)
  lastResetAt DateTime @default(now())
  warmupPhase Int      @default(1)
  warmupStart DateTime @default(now())
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  dailyLogs SendingLog[]
}

model SendingLog {
  id        String   @id @default(cuid())
  accountId String
  account   SendingAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  date      String
  sent      Int      @default(0)
  bounced   Int      @default(0)
  createdAt DateTime @default(now())

  @@unique([accountId, date])
}

model EmailCampaign {
  id          String    @id @default(cuid())
  subject     String
  body        String
  sentTo      Int       @default(0)
  totalLeads  Int       @default(0)
  sentAt      DateTime?
  scheduledAt DateTime?
  leadIds     String?
  status      String    @default("draft")

  // Bounce tracking
  bounceCount     Int    @default(0)
  bounceThreshold Int    @default(5) // Auto-pause at this bounce % rate

  // A/B testing variants (JSON array of {subject, body, weight})
  variants    String?

  createdAt   DateTime  @default(now())
}

model Sequence {
  id          String         @id @default(cuid())
  name        String
  active      Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  steps       SequenceStep[]
  enrollments SequenceEnrollment[]
}

model SequenceStep {
  id         String   @id @default(cuid())
  sequenceId String
  sequence   Sequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  order      Int
  delayDays  Int
  subject    String
  body       String
  createdAt  DateTime @default(now())

  @@unique([sequenceId, order])
}

model SequenceEnrollment {
  id          String    @id @default(cuid())
  sequenceId  String
  sequence    Sequence  @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  leadId      String
  currentStep Int       @default(0)
  nextSendAt  DateTime?
  status      String    @default("active")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([sequenceId, leadId])
}

model EmailTemplate {
  id        String   @id @default(cuid())
  name      String
  subject   String
  body      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EmailEvent {
  id         String   @id @default(cuid())
  leadId     String
  campaignId String?
  accountId  String?
  type       String   // sent, bounced, opened, clicked, replied, unsubscribed
  details    String?  // bounce reason, link clicked, etc.
  createdAt  DateTime @default(now())

  @@index([leadId])
  @@index([campaignId])
  @@index([type])
}
